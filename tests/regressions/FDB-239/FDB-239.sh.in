#!/usr/bin/env bash

set -eux

fdbread="$<TARGET_FILE:fdb-read>"
fdbwrite="$<TARGET_FILE:fdb-write>"
gribls="$<TARGET_FILE:grib_ls>"

srcdir=@CMAKE_CURRENT_SOURCE_DIR@
bindir=@CMAKE_CURRENT_BINARY_DIR@
wdir=$bindir/FDB-240

### cleanup and prepare test

rm -rf $bindir/localroot
mkdir localroot

for f in local.yaml schema mars.req in.grib
do
    cp $srcdir/$f $bindir
done

export FDB5_CONFIG_FILE=local.yaml

$fdbwrite in.grib

### tests with expanded request

$fdbread mars.req out.grib

cat > list <<EOF
g           sfc         20201102    0000        12          166.128     rd          fc          oper        xxxx
EOF

$gribls -m out.grib | tee out
grep oper out | sed 's/ *$//' > content
cmp list content


### tests with not expanded request

rm -f out.grib

$fdbread --raw mars.req out.grib

$gribls -m out.grib | tee out
grep oper out | sed 's/ *$//' > content
cmp list content
