#!/usr/bin/env bash

set -eux

# cd @CMAKE_CURRENT_BINARY_DIR@

cd FDB-238
export FDB5_CONFIG_FILE=local.yaml
@CMAKE_CURRENT_BINARY_DIR@/fdb-list --all --minimum-keys="" --porcelain | tee out
[[ "$(wc -l < out)" != "2" ]] && echo "Incorrect number of entries read from FDB" && exit -1
[[ "$(grep -E "$regex_0" out | wc -l)" != 2 ]] && echo "Incorrect number of entries read from FDB" && exit -1

@CMAKE_CURRENT_BINARY_DIR@/fdb-read checkV2.req checkV2.grib
grib_ls checkV2.grib | tee out
[[ "$(grep "1 of 1 messages in checkV2.grib" out | wc -l)" != 1 ]] && echo "Incorrect number of entries read from FDB" && exit -1

@CMAKE_CURRENT_BINARY_DIR@/fdb-write newField.grib
@CMAKE_CURRENT_BINARY_DIR@/fdb-list --all --minimum-keys="" --porcelain | tee out
[[ "$(wc -l < out)" != "3" ]] && echo "Incorrect number of entries read from FDB" && exit -1
[[ "$(grep -E "$regex_0" out | wc -l)" != 3 ]] && echo "Incorrect number of entries read from FDB" && exit -1

@CMAKE_CURRENT_BINARY_DIR@/fdb-read checkV3.req checkV3.grib
grib_ls checkV3.grib | tee out
[[ "$(grep "1 of 1 messages in checkV3.grib" out | wc -l)" != 1 ]] && echo "Incorrect number of entries read from FDB" && exit -1

@CMAKE_CURRENT_BINARY_DIR@/fdb-read checkV2.req checkV2_bis.grib
grib_ls checkV2_bis.grib | tee out
[[ "$(grep "1 of 1 messages in checkV2_bis.grib" out | wc -l)" != 1 ]] && echo "Incorrect number of entries read from FDB" && exit -1

diff checkV2.grib checkV2_bis.grib && echo "OK" && exit 0

echo "File differs"
exit -1


